# Rumpel Wallet

Rumpel Wallet pairs a Safe smart account with a Rumpel Guard and Module so we can run curated execution on behalf of users. Guard and module permissions now live in YAML and TypeScript under `list-sync/` and we still rely on the existing Forge scripts for contract development and deployments.

## Allowlist Workflow

### Directory layout
- `list-sync/tags/*.yaml` – declarative batches of guard and module changes.
- `list-sync/chains.yaml` – chain metadata, RPC env vars, and the ordered tag history for each chain.
- `list-sync/src` / `list-sync/dist` – TypeScript sources and the compiled CLI utilities (`diff`, `sync`, `verify`).
- `tmp/rumpel_config_dump.jsonl` – the historical snapshot used by the verification step (regenerated via `script/DumpRumpelConfig.s.sol`).
- `safe-batches/` – output directory for Safe Transaction Builder payloads generated by `sync`.

### Commands
Run all commands from the repo root:

```bash
npm install           # once
npm run build         # compile the TypeScript helpers
npm run typecheck     # sanity check changed files
npm run verify        # ensure YAML matches the legacy snapshot
npm run diff          # compare YAML configuration against on-chain state
npm run sync -- --tag <slug> [--chain ethereum,hyperEVM] [--dry-run]
```

Set `RPC_*` env vars (for example `RPC_MAINNET`) in your shell or `.envrc` before running `diff` or `sync`.

### Common tasks
1. **Add or edit a tag** – create/modify `list-sync/tags/<slug>.yaml`, populate `guard.allow`, `guard.tokens`, `module.block`, and `module.tokens` as needed, then `npm run typecheck` followed by `npm run verify`.
2. **Update chain history** – adjust the `tags` array for a chain inside `list-sync/chains.yaml` (append-only), rerun `npm run typecheck` and `npm run diff` to review the impact.
3. **Queue transactions** – `npm run sync -- --tag my-new-tag --dry-run` to review, then rerun without `--dry-run` to emit files in `safe-batches/`. Upload the JSON to the Safe Transaction Builder and execute. Finish with `npm run diff` to confirm parity.
4. **Run CI checks locally** – `npm run verify` stays strict so that any YAML change must reconcile with the legacy snapshot before landing.

### Refreshing the historical snapshot (rare)
1. Re-run the helper:
   ```bash
   forge script script/DumpRumpelConfig.s.sol --tc DumpRumpelConfig --sig "run()" \
     | sed -n 's/^  //p' > tmp/rumpel_config_dump.jsonl
   ```
2. If you need to rebuild the YAML archive from that snapshot, run `node list-sync/generate-allowlists.mjs`.
3. Only commit the refreshed snapshot when you intentionally change the baseline.

## Smart contract development

Foundry remains the way to develop and test the contracts that deploy the Guard, Module, and Factory:

```bash
forge install
forge build
forge test
```

Broadcast flows still work through the standard Foundry scripts under `script/`.
